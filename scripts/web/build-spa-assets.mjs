#!/usr/bin/env node

import { execSync } from 'node:child_process';
import { createHash } from 'node:crypto';
import { readFileSync, writeFileSync, rmSync } from 'node:fs';
import { resolve } from 'node:path';

const repoRoot = resolve(import.meta.dirname, '../..');
const spaRoot = resolve(repoRoot, 'src/web-spa');
const outDir = resolve(repoRoot, '.spa-dist');
const manifestPath = resolve(outDir, '.vite/manifest.json');
const outputFile = resolve(repoRoot, 'src/web/spa-assets.ts');

function runBuild() {
  execSync('pnpm exec vite build --config src/web-spa/vite.config.ts', {
    cwd: repoRoot,
    stdio: 'inherit',
  });
}

function loadManifest() {
  const raw = readFileSync(manifestPath, 'utf8');
  return JSON.parse(raw);
}

function main() {
  rmSync(outDir, { recursive: true, force: true });
  runBuild();

  const manifest = loadManifest();
  const entry = manifest['index.html'];
  if (!entry?.file) {
    throw new Error('Missing index.html entry in Vite manifest');
  }

  const jsPath = resolve(outDir, entry.file);
  const cssFile = Array.isArray(entry.css) && entry.css.length > 0 ? entry.css[0] : null;
  const cssPath = cssFile ? resolve(outDir, cssFile) : null;

  const jsContent = readFileSync(jsPath, 'utf8');
  const cssContent = cssPath ? readFileSync(cssPath, 'utf8') : '';

  const buildId = createHash('sha256')
    .update(jsContent)
    .update('\n')
    .update(cssContent)
    .digest('hex')
    .slice(0, 16);

  const generated = `// This file is auto-generated by scripts/web/build-spa-assets.mjs\n` +
    `export const SPA_BUILD_ID = ${JSON.stringify(buildId)};\n` +
    `export const SPA_JS = ${JSON.stringify(jsContent)};\n` +
    `export const SPA_CSS = ${JSON.stringify(cssContent)};\n`;

  let current = '';
  try {
    current = readFileSync(outputFile, 'utf8');
  } catch {
    current = '';
  }

  if (current !== generated) {
    writeFileSync(outputFile, generated, 'utf8');
  }
  rmSync(outDir, { recursive: true, force: true });

  console.log(`Generated ${outputFile}`);
}

main();
